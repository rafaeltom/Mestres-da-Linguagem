rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helpers ────────────────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Checks if the user is the owner (stamped in ownerId)
    function isOwner() {
      return isAuthenticated() && (
        (request.method == 'create' && request.resource.data.get('ownerId', '') == request.auth.uid) ||
        (request.method != 'create' && resource.data.get('ownerId', '') == request.auth.uid)
      );
    }

    // Checks if user is a collaborator of the class
    function isCollaboratorOfClass(classId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/classes/$(classId)) &&
        request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.get('sharedWith', []);
    }

    // ─── Users (profile) ────────────────────────────────────────────────────
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == uid;
    }

    // ─── Schools ────────────────────────────────────────────────────────────
    match /schools/{id} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner();
    }

    // ─── Classes ────────────────────────────────────────────────────────────
    match /classes/{id} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isOwner() || 
        (request.method == 'update' && (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['sharedWith'])
        ))
      );
    }

    // ─── Students ───────────────────────────────────────────────────────────
    match /students/{id} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isOwner() || 
        isCollaboratorOfClass(resource.data.get('classId', '')) ||
        isCollaboratorOfClass(request.resource.data.get('classId', ''))
      );
    }

    // ─── Transactions ────────────────────────────────────────────────────────
    match /transactions/{id} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isOwner() || 
        isCollaboratorOfClass(resource.data.get('classId', '')) ||
        isCollaboratorOfClass(request.resource.data.get('classId', ''))
      );
    }

    // ─── Catalog ─────────────────────────────────────────────────────────────
    match /catalog_tasks/{id} {
      allow read: if isAuthenticated(); 
      allow write: if isAuthenticated() && isOwner();
    }
    match /catalog_badges/{id} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner();
    }
    match /catalog_penalties/{id} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner();
    }

    // ─── License Keys ────────────────────────────────────────────────────────
    match /license_keys/{id} {
      // Normal users can read specific keys to claim them
      // Admins (verified by email and provider) can read/write everything
      allow read: if isAuthenticated() && (
        (request.auth.token.email in ['rafaelalmeida293@gmail.com', 'rafaeltomluz@gmail.com'] && 
         request.auth.token.firebase.sign_in_provider == 'google.com') ||
        (request.method == 'get') // normal users can 'get' a single key to check validity
      );
      allow write: if isAuthenticated() && (
        (request.auth.token.email in ['rafaelalmeida293@gmail.com', 'rafaeltomluz@gmail.com'] && 
         request.auth.token.firebase.sign_in_provider == 'google.com') ||
        (request.method == 'update' && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['used', 'usedBy', 'usedAt']) &&
         resource.data.used == false && 
         request.resource.data.used == true &&
         request.resource.data.usedBy == request.auth.uid)
      );
    }
  }
}

